# Linux-Specific Telegram Bot Setup Guide

This guide will help you set up the Telegram bot integration on Linux systems.

## Prerequisites

1. Docker and Docker Compose installed
2. Root or sudo access
3. A Telegram account

## Step 1: Install the AI Stack

First, ensure the entire AI stack is properly installed:

```bash
# Clone the repository if you haven't already
git clone https://github.com/ThijsdeZeeuw/cloud-local-ngrok.git
cd cloud-local-ngrok

# Make the installation script executable
chmod +x install.sh

# Run the installation script as root
sudo ./install.sh
```

This will set up all necessary containers including n8n, Ollama, ngrok, and other services.

## Step 2: Set Up the Telegram Webhook

We've provided a Bash script to easily set up the Telegram webhook. 

1. First, make the script executable:

```bash
chmod +x setup-telegram-webhook.sh
```

2. The script already contains the correct token (`7704615156:AAGydr3mul7LFXIg0zSDkDcNW8DhdCQhsLU`), but you can edit it if needed:

```bash
# Open the file with your preferred editor
nano setup-telegram-webhook.sh

# Check that the BOT_TOKEN is correctly set:
# BOT_TOKEN="7704615156:AAGydr3mul7LFXIg0zSDkDcNW8DhdCQhsLU"
```

3. Run the script:

```bash
./setup-telegram-webhook.sh
```

4. Choose option 1 to set up the webhook with the ngrok URL.

## Step 3: Check Container Status

Ensure all containers are running properly:

```bash
# Check container status
docker ps

# If any container is not running, you can check its logs
docker logs ai-stack_n8n_1
docker logs ai-stack_ngrok_1
```

## Step 4: Import the Telegram Workflow

1. Access n8n through your browser:
   - Local installation: `http://localhost:5678`
   - Remote server: `http://YOUR_SERVER_IP:5678`

2. Navigate to "Workflows" in the left sidebar

3. Click "Import from File"

4. Select the `examples/telegram-bot-workflow-custom.json` file

5. Click "Import" to add the workflow to your n8n instance

## Step 5: Configure the Telegram Nodes

1. Open the imported "Telegram AI Assistant with Ollama" workflow

2. Click on the "Telegram trigger" node

3. Click "Add Credential" to create a new Telegram API credential

4. Enter your bot token: `7704615156:AAGydr3mul7LFXIg0zSDkDcNW8DhdCQhsLU`

5. Save the credential

6. Check that the webhook is set to: `/webhook/322dce18-f93e-4f86-b9b1-3305519b7834/webhook`

7. Configure the "Send AI Response" node with the same Telegram credential

## Step 6: Activate the Workflow

1. Click the "Active" toggle in the top-right corner of the n8n interface

2. Confirm the activation

## Step 7: Test Your Telegram Bot

1. Open Telegram and find your bot by searching for it
   - The bot username should be something like `@your_bot_name`

2. Start a chat with your bot

3. Send a message to your bot

4. You should receive a response generated by the Ollama model

## Troubleshooting Linux-Specific Issues

### Docker Permission Issues

If you encounter permission errors with Docker:

```bash
# Add your user to the docker group
sudo usermod -aG docker $USER

# Log out and log back in for changes to take effect
# Or you can use this command to update your current session
newgrp docker
```

### Network Issues

If containers can't communicate with each other:

```bash
# Check Docker network status
docker network ls
docker network inspect ai-stack_backend

# Restart Docker service if needed
sudo systemctl restart docker
```

### Firewall Issues

If external connections are blocked:

```bash
# For UFW (Ubuntu's firewall)
sudo ufw allow 5678/tcp  # n8n
sudo ufw allow 4040/tcp  # ngrok dashboard

# For firewalld (CentOS/RHEL)
sudo firewall-cmd --permanent --add-port=5678/tcp
sudo firewall-cmd --permanent --add-port=4040/tcp
sudo firewall-cmd --reload
```

### Checking Webhook Status

To quickly check if your webhook is set up correctly:

```bash
# Use curl to check the webhook status
curl -s "https://api.telegram.org/bot7704615156:AAGydr3mul7LFXIg0zSDkDcNW8DhdCQhsLU/getWebhookInfo" | json_pp
```

## Automatic Updates

To keep your stack updated on Linux:

```bash
cd cloud-local-ngrok
chmod +x update-script.sh
sudo ./update-script.sh
```

## Linux Service Setup (Optional)

To ensure your Docker containers start on boot, you can create a systemd service:

```bash
# Create a new service file
sudo nano /etc/systemd/system/ai-stack.service

# Add the following content
[Unit]
Description=AI Stack with Telegram Bot
After=docker.service
Requires=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/path/to/cloud-local-ngrok
ExecStart=/usr/bin/docker-compose up -d
ExecStop=/usr/bin/docker-compose down
TimeoutStartSec=0

[Install]
WantedBy=multi-user.target

# Save and close the file, then enable and start the service
sudo systemctl daemon-reload
sudo systemctl enable ai-stack.service
sudo systemctl start ai-stack.service
```

This setup ensures your Telegram bot will continue working even after system restarts.